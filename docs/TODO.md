# kilar 実装計画

## 🎯 プロジェクト概要
ポートプロセス管理CLIツール「kilar」の実装計画。
開発者がよく遭遇する「ポートが既に使用されている」問題を簡単に解決するツール。

## 📋 実装タスクリスト

### Phase 1: 基盤構築 🏗️

#### 1.1 プロジェクト構造の設定
- [x] CLIアプリケーション構造の作成
  - [x] `src/main.rs` - エントリーポイント
  - [x] `src/cli.rs` - CLIコマンド定義
  - [x] `src/lib.rs` - ライブラリのルート
- [x] モジュール構成の設計
  - [x] `src/commands/` - コマンド実装
  - [x] `src/port/` - ポート管理機能
  - [x] `src/process/` - プロセス管理機能
  - [x] `src/utils/` - ユーティリティ関数
  - [x] `src/error.rs` - エラー型定義

#### 1.2 CLI基本実装
- [x] Clapを使用したCLI構造の実装
  - [x] メインコマンド構造
  - [x] サブコマンド定義（check, kill, list）
  - [x] グローバルオプション（--verbose, --quiet, --json）
  - [x] ヘルプメッセージのカスタマイズ
- [x] エラーハンドリングの基盤
  - [x] カスタムエラー型の定義
  - [x] Result型を使用したエラー伝播
  - [x] ユーザーフレンドリーなエラーメッセージ

### Phase 2: コア機能実装 💡

#### 2.1 ポート情報取得機能
- [x] プラットフォーム別の実装
  - [x] macOS/Linux: `lsof` コマンドのラッパー
  - [x] Windows: `netstat` コマンドのラッパー（基本サポート）
- [x] ポート情報のパース
  - [x] コマンド出力のパース処理
  - [x] ポート情報構造体の定義
  - [x] エラーケースの処理

#### 2.2 `check` コマンド実装
- [x] ポート使用状況の確認機能
  - [x] 指定ポートの検索
  - [x] プロセス情報の取得（PID、名前、コマンド）
  - [x] プロトコル情報（TCP/UDP）の取得
- [x] 出力フォーマット
  - [x] 通常出力（colored出力）
  - [x] JSON出力オプション
  - [x] Quiet/Verboseモード

#### 2.3 `kill` コマンド実装
- [x] プロセス終了機能
  - [x] ポートからPIDの特定
  - [x] プロセスの停止処理
  - [x] 権限チェックとエラーハンドリング
- [x] 対話的確認
  - [x] dialoguerを使用した確認プロンプト
  - [x] --forceオプションでスキップ
  - [ ] 複数プロセスの選択機能（基本機能は完了）

#### 2.4 `list` コマンド実装
- [x] ポート一覧表示機能
  - [x] すべての使用中ポートの取得
  - [x] ポート範囲フィルタリング（--ports）
  - [x] プロセス名フィルタリング（--filter）
- [x] ソート機能
  - [x] ポート番号順
  - [x] PID順
  - [x] プロセス名順
- [x] 表形式の出力
  - [x] テーブル表示
  - [x] カラー対応
  - [x] JSON出力サポート

### Phase 3: ユーザビリティ向上 ✨

#### 3.1 エラーメッセージの改善
- [ ] わかりやすいエラーメッセージ
  - [ ] ポートが使用されていない場合
  - [ ] 権限不足の場合（sudo提案）
  - [ ] 無効なポート番号
  - [ ] コマンドが見つからない場合

#### 3.2 出力フォーマットの最適化
- [ ] カラー出力の実装
  - [ ] 成功メッセージ（緑）
  - [ ] エラーメッセージ（赤）
  - [ ] 警告メッセージ（黄）
  - [ ] 情報表示（青）
- [ ] 表示フォーマットのカスタマイズ
  - [ ] コンパクト表示
  - [ ] 詳細表示
  - [ ] JSON出力

#### 3.3 パフォーマンス最適化
- [ ] 非同期処理の実装（Tokio）
  - [ ] コマンド実行の非同期化
  - [ ] 並列処理の最適化
- [ ] キャッシング戦略
  - [ ] ポート情報のキャッシング（必要に応じて）

### Phase 4: テストとドキュメント 📚

#### 4.1 テスト実装
- [ ] 単体テスト
  - [ ] 各モジュールのユニットテスト
  - [ ] パース処理のテスト
  - [ ] エラーケースのテスト
- [ ] 統合テスト
  - [ ] コマンド実行テスト
  - [ ] エンドツーエンドテスト
- [ ] モックテスト
  - [ ] システムコマンドのモック
  - [ ] プラットフォーム別テスト

#### 4.2 ドキュメント作成
- [ ] README.md
  - [ ] インストール方法
  - [ ] 使用方法
  - [ ] コマンド例
- [ ] API ドキュメント
  - [ ] rustdocコメント
  - [ ] 使用例の追加
- [ ] CONTRIBUTING.md
  - [ ] 開発環境のセットアップ
  - [ ] コーディング規約
  - [ ] プルリクエストガイドライン

### Phase 5: 配布とリリース 🚀

#### 5.1 ビルド設定
- [ ] リリースビルドの最適化
  - [ ] バイナリサイズの最小化
  - [ ] 実行速度の最適化
  - [ ] ストリップ設定
- [ ] クロスコンパイル設定
  - [ ] macOS (x86_64, aarch64)
  - [ ] Linux (x86_64, aarch64)
  - [ ] Windows (x86_64)

#### 5.2 配布準備
- [ ] GitHub Releasesの設定
  - [ ] リリースワークフロー
  - [ ] 自動ビルド設定
  - [ ] リリースノート自動生成
- [ ] Cargo.tomlの最終調整
  - [ ] メタデータの完成
  - [ ] 依存関係の最適化
- [ ] crates.io への公開準備
  - [ ] ライセンス確認
  - [ ] ドキュメント確認
  - [ ] バージョニング戦略

### Phase 6: 将来の拡張（オプション）🔮

#### 6.1 設定ファイル機能
- [ ] 設定ファイルのサポート
  - [ ] TOML形式の設定ファイル
  - [ ] デフォルト設定
  - [ ] カスタムエイリアス

#### 6.2 高度な機能
- [ ] ポート使用履歴の記録
- [ ] プロセスグループ管理
- [ ] 自動リトライ機能
- [ ] WebUIダッシュボード（将来）

## 🛠️ 技術スタック

- **言語**: Rust (Edition 2021)
- **主要クレート**:
  - `clap` (v4.5): CLI引数パーサー
  - `tokio` (v1.40): 非同期ランタイム
  - `serde` / `serde_json`: シリアライゼーション
  - `colored` (v2.1): カラー出力
  - `dialoguer` (v0.11): 対話的プロンプト
  - `anyhow` (v1.0): エラーハンドリング

## 📊 進捗トラッキング

- Phase 1: 基盤構築 [x] 100% ✅ **完了済み** (2025-08-21)
- Phase 2: コア機能実装 [x] 100% ✅ **完了済み** (2025-08-21)
- Phase 3: ユーザビリティ向上 [ ] 0%
- Phase 4: テストとドキュメント [ ] 0%
- Phase 5: 配布とリリース [ ] 0%
- Phase 6: 将来の拡張 [ ] 0%

## 📝 メモ

- プラットフォーム依存の処理は抽象化層を設ける
- エラーメッセージは日本語/英語の両方をサポート（将来的に）
- セキュリティを考慮し、適切な権限チェックを実装
- ユーザーエクスペリエンスを重視した設計

### Phase 1 完了時の実装詳細 ✅ (2025-08-21)
- **CLI構造**: Clap v4.5を使用した完全なコマンドライン体験
- **非同期処理**: Tokio統合による効率的なシステムコマンド実行
- **エラーハンドリング**: 日本語メッセージ対応の包括的エラー処理システム
- **クロスプラットフォーム**: Unix系（lsof）とWindows（netstat/taskkill）対応
- **出力オプション**: JSON、カラー出力、詳細/静寂モード完全サポート
- **コマンド実装**: check/kill/listの基本構造とバリデーション
- **修正済み**: CLI引数競合問題（-pオプションの重複解決）

### Phase 2 完了時の実装詳細 ✅ (2025-08-21)
- **ポート検出**: lsof/netstatを使用した正確なポート使用状況取得
- **プロトコル対応**: TCP/UDPの適切な分離処理と表示
- **checkコマンド**: ポート状況確認、JSON/verbose出力完全対応
- **killコマンド**: プロセス終了機能、対話的確認、権限エラー処理
- **listコマンド**: フィルタリング（ポート範囲・プロセス名）、ソート機能
- **出力品質**: カラー表示、テーブル形式、統計情報表示
- **修正済み**: lsofパーサーのプロトコル判定ロジック改善

## 🎯 次のステップ

1. **Phase 3.1** から開始：エラーメッセージの改善と多言語対応
2. **Phase 3.2**: カラー出力とフォーマットの最適化
3. **Phase 4.1**: 単体テストと統合テスト実装
4. **Phase 5.1**: クロスコンパイルとリリースビルド設定

---

最終更新: 2025-08-21