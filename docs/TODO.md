# kilar 実装計画

## 🎯 プロジェクト概要
ポートプロセス管理CLIツール「kilar」の実装計画。
開発者がよく遭遇する「ポートが既に使用されている」問題を簡単に解決するツール。

## 📋 実装タスクリスト

### Phase 1: 基盤構築 🏗️

#### 1.1 プロジェクト構造の設定
- [x] CLIアプリケーション構造の作成
  - [x] `src/main.rs` - エントリーポイント
  - [x] `src/cli.rs` - CLIコマンド定義
  - [x] `src/lib.rs` - ライブラリのルート
- [x] モジュール構成の設計
  - [x] `src/commands/` - コマンド実装
  - [x] `src/port/` - ポート管理機能
  - [x] `src/process/` - プロセス管理機能
  - [x] `src/utils/` - ユーティリティ関数
  - [x] `src/error.rs` - エラー型定義

#### 1.2 CLI基本実装
- [x] Clapを使用したCLI構造の実装
  - [x] メインコマンド構造
  - [x] サブコマンド定義（check, kill, list）
  - [x] グローバルオプション（--verbose, --quiet, --json）
  - [x] ヘルプメッセージのカスタマイズ
- [x] エラーハンドリングの基盤
  - [x] カスタムエラー型の定義
  - [x] Result型を使用したエラー伝播
  - [x] ユーザーフレンドリーなエラーメッセージ

### Phase 2: コア機能実装 💡

#### 2.1 ポート情報取得機能
- [x] プラットフォーム別の実装
  - [x] macOS/Linux: `lsof` コマンドのラッパー
  - [x] Windows: `netstat` コマンドのラッパー（基本サポート）
- [x] ポート情報のパース
  - [x] コマンド出力のパース処理
  - [x] ポート情報構造体の定義
  - [x] エラーケースの処理

#### 2.2 `check` コマンド実装
- [x] ポート使用状況の確認機能
  - [x] 指定ポートの検索
  - [x] プロセス情報の取得（PID、名前、コマンド）
  - [x] プロトコル情報（TCP/UDP）の取得
- [x] 出力フォーマット
  - [x] 通常出力（colored出力）
  - [x] JSON出力オプション
  - [x] Quiet/Verboseモード

#### 2.3 `kill` コマンド実装
- [x] プロセス終了機能
  - [x] ポートからPIDの特定
  - [x] プロセスの停止処理
  - [x] 権限チェックとエラーハンドリング
- [x] 対話的確認
  - [x] dialoguerを使用した確認プロンプト
  - [x] --forceオプションでスキップ
  - [ ] 複数プロセスの選択機能（基本機能は完了）

#### 2.4 `list` コマンド実装
- [x] ポート一覧表示機能
  - [x] すべての使用中ポートの取得
  - [x] ポート範囲フィルタリング（--ports）
  - [x] プロセス名フィルタリング（--filter）
- [x] ソート機能
  - [x] ポート番号順
  - [x] PID順
  - [x] プロセス名順
- [x] 表形式の出力
  - [x] テーブル表示
  - [x] カラー対応
  - [x] JSON出力サポート

### Phase 3: ユーザビリティ向上 ✨

#### 3.1 エラーメッセージの改善
- [x] わかりやすいエラーメッセージ
  - [x] ポートが使用されていない場合
  - [x] 権限不足の場合（sudo提案）
  - [x] 無効なポート番号
  - [x] コマンドが見つからない場合

#### 3.2 出力フォーマットの最適化
- [x] カラー出力の実装
  - [x] 成功メッセージ（緑）
  - [x] エラーメッセージ（赤）
  - [x] 警告メッセージ（黄）
  - [x] 情報表示（青）
- [x] 表示フォーマットのカスタマイズ
  - [x] コンパクト表示
  - [x] 詳細表示（--verbose）
  - [x] JSON出力

#### 3.3 パフォーマンス最適化
- [x] 非同期処理の実装（Tokio）
  - [x] コマンド実行の非同期化
  - [x] 並列処理の最適化
- [ ] キャッシング戦略
  - [ ] ポート情報のキャッシング（必要に応じて）

### Phase 4: テストとドキュメント 📚

#### 4.1 テスト実装
- [x] 単体テスト
  - [x] 各モジュールのユニットテスト
  - [x] パース処理のテスト
  - [x] エラーケースのテスト
- [x] 統合テスト
  - [x] コマンド実行テスト
  - [x] エンドツーエンドテスト
- [ ] モックテスト
  - [ ] システムコマンドのモック
  - [ ] プラットフォーム別テスト

#### 4.2 ドキュメント作成
- [x] README.md
  - [x] インストール方法
  - [x] 使用方法
  - [x] コマンド例
- [x] API ドキュメント
  - [x] rustdocコメント
  - [x] 使用例の追加
- [x] CONTRIBUTING.md
  - [x] 開発環境のセットアップ
  - [x] コーディング規約
  - [x] プルリクエストガイドライン

### Phase 5: 配布とリリース 🚀

#### 5.1 ビルド設定
- [x] リリースビルドの最適化
  - [x] バイナリサイズの最小化（1.1MB）
  - [x] 実行速度の最適化（LTO有効）
  - [x] ストリップ設定
- [x] クロスコンパイル設定
  - [x] macOS (x86_64, aarch64)
  - [x] Linux (x86_64, aarch64)
  - [x] Windows (x86_64)

#### 5.2 配布準備
- [x] GitHub Releasesの設定
  - [x] リリースワークフロー
  - [x] 自動ビルド設定
  - [x] リリースノート自動生成
- [x] Cargo.tomlの最終調整
  - [x] メタデータの完成
  - [x] 依存関係の最適化
- [x] crates.io への公開準備
  - [x] ライセンス確認（MIT）
  - [x] ドキュメント確認
  - [x] バージョニング戦略

#### 5.3 CI/CD設定
- [x] GitHub Actions CI設定
  - [x] マルチプラットフォームテスト
  - [x] セキュリティ監査
  - [x] コードカバレッジ
- [x] 自動リリースパイプライン
  - [x] タグベースリリース
  - [x] クロスプラットフォームビルド
  - [x] crates.io自動公開

### Phase 6: 将来の拡張（オプション）🔮

#### 6.1 設定ファイル機能
- [ ] 設定ファイルのサポート
  - [ ] TOML形式の設定ファイル
  - [ ] デフォルト設定
  - [ ] カスタムエイリアス

#### 6.2 高度な機能
- [ ] ポート使用履歴の記録
- [ ] プロセスグループ管理
- [ ] 自動リトライ機能
- [ ] WebUIダッシュボード（将来）

## 🛠️ 技術スタック

- **言語**: Rust (Edition 2021)
- **主要クレート**:
  - `clap` (v4.5): CLI引数パーサー
  - `tokio` (v1.40): 非同期ランタイム
  - `serde` / `serde_json`: シリアライゼーション
  - `colored` (v2.1): カラー出力
  - `dialoguer` (v0.11): 対話的プロンプト
  - `anyhow` (v1.0): エラーハンドリング

## 📊 進捗トラッキング

- Phase 1: 基盤構築 [x] 100% ✅ **完了済み** (2025-08-21)
- Phase 2: コア機能実装 [x] 100% ✅ **完了済み** (2025-08-21)
- Phase 3: ユーザビリティ向上 [x] 95% ✅ **ほぼ完了** (2025-08-21)
- Phase 4: テストとドキュメント [x] 90% ✅ **ほぼ完了** (2025-08-21)
- Phase 5: 配布とリリース [x] 100% ✅ **完了済み** (2025-08-21)
- Phase 6: 将来の拡張 [ ] 0%

## 📝 メモ

- プラットフォーム依存の処理は抽象化層を設ける
- エラーメッセージは日本語/英語の両方をサポート（将来的に）
- セキュリティを考慮し、適切な権限チェックを実装
- ユーザーエクスペリエンスを重視した設計

### Phase 1 完了時の実装詳細 ✅ (2025-08-21)
- **CLI構造**: Clap v4.5を使用した完全なコマンドライン体験
- **非同期処理**: Tokio統合による効率的なシステムコマンド実行
- **エラーハンドリング**: 日本語メッセージ対応の包括的エラー処理システム
- **クロスプラットフォーム**: Unix系（lsof）とWindows（netstat/taskkill）対応
- **出力オプション**: JSON、カラー出力、詳細/静寂モード完全サポート
- **コマンド実装**: check/kill/listの基本構造とバリデーション
- **修正済み**: CLI引数競合問題（-pオプションの重複解決）

### Phase 2 完了時の実装詳細 ✅ (2025-08-21)
- **ポート検出**: lsof/netstatを使用した正確なポート使用状況取得
- **プロトコル対応**: TCP/UDPの適切な分離処理と表示
- **checkコマンド**: ポート状況確認、JSON/verbose出力完全対応
- **killコマンド**: プロセス終了機能、対話的確認、権限エラー処理
- **listコマンド**: フィルタリング（ポート範囲・プロセス名）、ソート機能
- **出力品質**: カラー表示、テーブル形式、統計情報表示
- **修正済み**: lsofパーサーのプロトコル判定ロジック改善

### Phase 3 完了時の実装詳細 ✅ (2025-08-21)
- **エラーメッセージ**: 英語化と詳細なコンテキスト情報の追加
- **権限エラー**: sudo提案メッセージの実装
- **カラー出力**: 統一的なカラースキーム（成功:緑、エラー:赤、警告:黄、情報:青）
- **Verboseモード**: --verboseオプションで詳細情報表示
- **コード品質**: すべてのコマンドで一貫性のある出力フォーマット
- **パフォーマンス**: Tokio非同期処理の活用

### Phase 4 完了時の実装詳細 ✅ (2025-08-21)
- **テスト体系**: ユニットテスト、統合テスト、ドキュメントテストの実装
- **テストカバレッジ**: エラーケース、パース処理、バリデーション機能の包括的テスト
- **ドキュメント**: 英語版README、CONTRIBUTING.md、rustdocコメントの完備
- **開発環境**: テスト実行、コード品質チェック、フォーマット確認の自動化
- **コード品質**: clippy警告の解消とフォーマット統一

### Phase 5 完了時の実装詳細 ✅ (2025-08-21)
- **リリースビルド**: LTO最適化、ストリップ設定、1.1MBの軽量バイナリ
- **クロスプラットフォーム**: macOS(x86_64/aarch64)、Linux(x86_64/aarch64)、Windows対応
- **CI/CDパイプライン**: GitHub Actions完全自動化（テスト、ビルド、リリース）
- **配布準備**: crates.io公開対応、MIT ライセンス、完全なメタデータ
- **セキュリティ**: cargo audit統合、依存関係脆弱性チェック
- **開発ツール**: Makefile、リリースワークフロー、自動バージョニング

## 🎯 プロジェクト完了

**kilar v0.1.0** は完全に実装され、本格的なリリース準備が整いました！

### 🚀 リリース準備完了項目
1. ✅ 全機能実装済み（check/kill/list コマンド）
2. ✅ 包括的テストスイート（17テスト通過）
3. ✅ 英語版ドキュメント完備
4. ✅ CI/CD自動化
5. ✅ クロスプラットフォーム対応
6. ✅ crates.io公開準備完了

### 📦 次の段階（Phase 6以降）
- 実際のリリース（タグ作成）
- 使用フィードバック収集
- コミュニティ貢献
- 将来機能の検討

---

最終更新: 2025-08-21